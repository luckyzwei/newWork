<?php

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of KillProduct
 *
 * @author wangxiangshuai
 */
class KillProduct extends CI_Controller {

    //put your code here
    public function __construct() {
        parent::__construct();
        $this->load->model('KillProductModel');
        $this->load->helper('string');
    }

    public function get_killproducts() {
        $page = $this->input->post('page') ? $this->input->post('page') : 1;
        $limit = $this->input->post('limit') ? $this->input->post('limit') : 10;

        $killproductList = $this->KillProductModel->getKillProducts($page, $limit);

        foreach ($killproductList as &$product) {
            $product['thumb'] = reduce_double_slashes($this->systemsetting->get("img_url") . $this->systemsetting->get("file_upload_dir") . $product['thumb']);
        }

        $this->output->set_content_type("application/json")->set_output(json_encode(array('data' => $killproductList, 'error_code' => 0)));
    }

    public function get_killproduct() {
        $kill_product_id = $this->input->post("kill_product_id");
        $killproduct = $this->KillProductModel->getKillProduct($kill_product_id);
        if (!empty($killproduct)) {
            $killproduct['thumb'] = reduce_double_slashes($this->systemsetting->get("img_url") . $this->systemsetting->get("file_upload_dir") . $killproduct['thumb']);
            $images = unserialize($killproduct['images']);
            if (!empty($images)) {
                $killproduct['images'] = array();
                foreach ($images as $value) {
                    $killproduct['images'][] = reduce_double_slashes($this->systemsetting->get("img_url") . $this->systemsetting->get("file_upload_dir") . $value);
                }
            }
            if (empty($killproduct['kill_product_endtime'])) {
                $killproduct['kill_product_endtime'] = 260000;
            } else {
                $killproduct['kill_product_endtime'] -= time();
            }
        }

        $this->output->set_content_type("application/json")->set_output(json_encode(array('data' => $killproduct, 'error_code' => 0)));
    }

    /**
     * 检查开团数据
     */
    public function check_kill($return = false) {
        $error_code = 0;
        $data = array();
        $this->load->model('addressModel');
        $kill_product_id = $this->input->post("kill_product_id");
        $address_id = $this->input->post('address_id');
        $user_id = $this->session->user_id;

        $data['killproduct'] = $this->KillProductModel->getKillProduct($kill_product_id);


        if (empty($data['killproduct'])) {
            $data = "活动已结束";
            $error_code = 1;
        } else {
            if (!empty($data['killproduct']['kill_product_endtime'])) {
                if ($data['killproduct']['kill_product_endtime'] < time()) {
                    $data = "活动已结束";
                    $error_code = 1;
                }
            }
        }
        if (empty($error_code) && $data['killproduct']['kill_product_store'] < 1) {
            $error_code = 1;
            $data = '库存不足';
        }
        if (empty($error_code)) {
            $data['products'][] = array(
                'thumb' => reduce_double_slashes($this->systemsetting->get("img_url") . $this->systemsetting->get("file_upload_dir") . $data['killproduct']['thumb']),
                'product_name' => $data['killproduct']['product_name'],
                'product_price' => $data['killproduct']['market_price'],
                'product_number' => 1,
                'supplier_id' => 0
            );
            $shipping_fee = 0;
            $data['addressinfo'] = $address = $this->addressModel->getAddressInfo($user_id, $address_id);
            $config = $this->systemsetting->get("shipping_fee_template");
            if (!$config) {//不启用运费模板
                $shipping_fee = $this->systemsetting->get("shipping_fee");
            }
            if ($config) {
                //根据区域id获取当前区域的运费配置
                $logistic_config = $this->addressModel->getLogisticsList($address['district_id']);
                if (empty($logistic_config)) {//没有配置区域运费使用系统默认统一运费
                    $shipping_fee = $this->systemsetting->get("shipping_fee");
                } else {
                    $lconfig = $logistic_config[0];
                    $product_weight = $data['killproduct']['product_weight'] / 1000;
                    $overstep_weight = $product_weight - $lconfig['logistics_weight'];
                    if ($overstep_weight <= 0) {
                        $shipping_fee = $lconfig['logistics_fee'];
                    } else {
                        $shipping_fee = $lconfig['logistics_fee'] + ceil($overstep_weight) * $lconfig['logistics_add_fee'];
                    }
                }
            } else {
                $shipping_fee = $this->systemsetting->get("shipping_fee");
            }
            $data['coupon'] = array();
            $data['check_marketings'] = '';
            $total_price = $data['killproduct']['market_price'];
            $data['product_price'] = round($total_price, 2);
            $data['cuca'] = 0;
            $data['shipping_fee'] = round($shipping_fee, 2);
            $data['coupon_discount'] = 0;
            $data['total_amount'] = $data['total_price'] = round($total_price + $shipping_fee, 2); //订单总计金额
        }
        if ($return) {
            return $data;
        }
        $json = array("error_code" => $error_code, 'data' => $data);
        $this->output->set_content_type("application/json")->set_output(json_encode($json));
    }

    public function create_kill_order() {
        $user_id = $this->session->user_id;
        $kill_product_id = $this->input->post("kill_product_id");
        $data = $this->check_kill(true);
        $error_code = 0;
        if (!is_array($data)) {
            $error_code = 1;
        } elseif (empty($data['addressinfo'])) {
            $error_code = 2;
            $data = '地址不存在';
        }
        //检查是否在该活动有订单
        $killorders = $this->KillProductModel->checkKillOrder($user_id, $kill_product_id);
        if ($killorders) {
            $error_code = 3;
            $data = '存在未支付活动';
        }

        if (empty($error_code) && !empty($data['products'])) {
            $orderdata = array(
                "order_amount" => $data['total_amount'],
                "user_id" => $user_id,
                "product_amount" => $data['product_price'],
                "address" => $data['addressinfo']['province_name'] . ' ' . $data['addressinfo']['city_name'] . ' ' . $data['addressinfo']['district_name'] . ' ' . $data['addressinfo']['address'],
                "coupon_id" => '',
                "save_money" => 0,
                "order_type" => "K",
                "createtime" => time(),
                "fullname" => $data['addressinfo']['name'],
                "telephone" => $data['addressinfo']['telephone'],
                "payment_id" => "2",
                "payment_name" => "微信小程序支付",
                "postage" => $data['shipping_fee'],
                "from_id" => $this->session->user_info['parent_user_id'],
                'remark' => $this->input->post("remark")
            );

            $orderdata['order_marketings'] = array();

            $orderdata['products'] = $data['products'];

            $orderdata['coupon'] = $data['coupon'];
            $this->load->model("orderModel");
            $orderdata['groupbuy_data'] = array();
            $order_id = $this->orderModel->addOrder($orderdata);
            //增加统计表中的订单金额-
            $this->load->model("staticsModel");
            $this->staticsModel->update(array("totalfee", $data['total_amount']));

            $data = array("order_id" => $order_id, "amount" => $data['total_amount']);
        }
        $json = array("error_code" => $error_code, "data" => $data);
        $this->output->set_content_type("application/json")->set_output(json_encode($json));
    }

}
