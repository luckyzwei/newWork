//拼团商品详情
const App = getApp()
Page({
  data: {
    userInfo: {},
    storeInfo: {},
    hasUserInfo: false,
    canIUse: wx.canIUse('button.open-type.getUserInfo'),
    choose_modal: "none", //弹出层的初始状态是隐藏
    num: 1, //初始数量
    minusStatus: 'disabled', //禁用减号
    groupproduct: {},
    default_special_price: 0,
    cartProductNum: 0,
    curIndex: 0,
    group_product_id: '',
    reviews: {},
    commentPage: 1,
    buy_button: '',
    star: [0, 1, 2, 3, 4],
    times: 0,
    h: '',
    day: '',
    m: '',
    limitWarning: "距离结束仅剩"
  },
  onShow: function() {
    var that = this;
    App.checkAuth();
    App.checkCartNum(function(cartnum) {
      that.setData({
        "cartProductNum": cartnum
      });
    });
  },

  onLoad: function(options) {
    var that = this;
    var group_product_id = options.group_product_id;
    that.setData({
      group_product_id: group_product_id
    })
    App.initialize(function() {
      that.setData({
        "storeInfo": wx.getStorageSync("storeInfo"),
        "userInfo": wx.getStorageSync("user_data")
      }, function() {
        that.setData({
          "shopkeeper": that.data.userInfo.store_id ? true : false,
        });
      });
      wx.hideShareMenu();
      that.get_groupproduct();
    });
  },

  /**获取当前商品信息 */
  get_groupproduct: function() {
    var that = this;
    wx.showLoading({
      title: '努力加载中……',
      mask: true,
      success: function(res) {
        App.apiPost({
          "uri": 'GroupProduct/get_groupproduct.html',
          "data": {
            group_product_id: that.data.group_product_id,
          },
          "callback": function(res) {
            if (!res.error_code) {
              /** 清除详情图片上下之间空隙 */
              res.data.description = res.data.description.replace(/style="width:.+?100%;"/gi, ' style="width:100%;display:block;" ')
              that.setData({
                "groupproduct": res.data,
                "times": res.data.endtime
              }, function () {
                that.countdown(that.data.times);
              });
            }
            wx.hideLoading();
          }
        })
      },

    })
  },

  /**导航到首页 */
  showStore: function() {
    wx.switchTab({
      url: '/pages/index/index',
    })
  },
  /**导航购物车页 */
  showCart: function() {
    wx.switchTab({
      url: '/pages/shopcar/shopcar',
    })
  },
  /**购买/加入购物车 */
  addToCart: function(e) {
    var that = this;
    var click_button = that.data.buy_button;

    var data = {
      "product_id": that.data.groupproduct.product_id,
      "product_number": that.data.num,
      "product_type": "G",
      "product_special_id": "",
    };
    //判断规格是否选择完毕
    var product_special_id = 0;
    App.apiPost({
      'uri': 'Cart/add_cart.html',
      'data': data,
      'callback': function(res) {
        if (!res.error_code) {
          if (click_button == "addCart") {
            wx.showToast({
              'title': '加入成功',
              'icon': 'none',
              'success': function() {
                that.setData({
                  choose_modal: "none",
                });
              },
            })
            App.checkCartNum();
          }
          if (click_button == "goBuy") {
            that.setData({
              choose_modal: "none",
            }, function() {
              var cart_id = res.data.cart_id;
              that.nowCheckout(cart_id);
            })

          }
        } else {
          console.log(res);
        }
      }
    })
  },
  /**处理立即购买 */
  nowCheckout: function(cart_id) {
    //把其它商品设置为不结算
    App.apiPost({
      'uri': 'cart/set_cart_check_status.html',
      'data': {
        'cart_id': "all",
        "chk_status": 0
      },
      'callback': function(res) {
        if (!res.error_code) {
          //把当前cart_id设置为结算
          App.apiPost({
            'uri': 'cart/set_cart_check_status.html',
            'data': {
              'cart_id': cart_id,
              "chk_status": 1
            },
            'callback': function(res) {
              if (!res.error_code) {
                wx.navigateTo({
                  url: '/pages/checkout/checkout',
                })
              } else {
                console.log(res);
              }
            }
          })
        } else {
          console.log(res);
        }
      }
    });


  },



  /* 点击减号 */
  bindMinus: function() {
    var num = this.data.num;
    // 如果大于1，可以减
    if (num > 1) {
      num--;
    }
    // 只有大于1的时候，才能normal状态进行减法，否则disable状态
    var minusStatus = num <= 1 ? 'disabled' : 'normal';
    // 将数值与状态写回
    this.setData({
      num: num,
      minusStatus: minusStatus
    });
  },
  /* 点击加号*/
  bindPlus: function() {
    var num = this.data.num;
    // 不作过多考虑自增1
    num++;
    // 小于1,为disable状态
    var minusStatus = num < 1 ? 'disabled' : 'normal';
    // 将数值与状态写回
    this.setData({
      num: num,
      minusStatus: minusStatus
    });

  },
  /* 输入框事件 */
  bindManual: function(e) {
    var num = e.detail.value;
    if (isNaN(num)) {
      num = 1;
    }
    // 将数值与状态写回
    this.setData({
      num: parseInt(num)
    });
  },
  //弹出
  modal_show: function(e) {
    this.setData({
      buy_button: e.currentTarget.dataset.button,
      choose_modal: "block",
    });
  },
  //消失
  modal_none: function() {
    this.setData({
      choose_modal: "none",
    });
  },
  /**切换详情 评论列表 */
  changeTap: function(e) {
    var that = this;
    var index = e.currentTarget.dataset.index;
    that.setData({
      curIndex: index
    })
    if (index == 1) {
      that.getComment();
    }
  },
  getComment: function() {
    var that = this;
    wx.showLoading({
      title: '努力加载中……',
      mask: true,
      success: function(res) {
        App.apiPost({
          "uri": 'ProductComment/get_product_comments.html',
          "data": {
            product_id: that.data.groupproduct.product_id,
            store_id: that.data.storeInfo.store_id,
            page: that.data.commentPage
          },
          "callback": function(res) {
            if (!res.error_code) {
              that.setData({
                "reviews": res.data,
              });
              wx.hideLoading();
            }
          }
        })
      },

    })
  },

  /* 毫秒级秒杀倒计时 */
  countdown: function(times) {
    var that = this;
    var day = Math.floor(times / 3600 / 24);
    var hr = Math.floor(times / 3600);
    var hr2 = hr % 24; 
    var min = Math.floor((times - hr * 3600) / 60); 
    var sec = (times - hr * 3600 - min * 60); 
    // 渲染倒计时时钟
    that.setData({
      h: hr2, //格式化时间
      day: day,
      m: min,
      s: sec
    });
    times = times - 1000;
    if (times <= 0 || isNaN(times)) {
      that.setData({
        limitWarning: "拼团已结束"
      });
      return;
    } else {
      that.setData({
        times: times
      });
    }
    //settimeout实现倒计时效果
    setTimeout(function() {
      that.countdown(times);
    }, 1000)
  },
})